---
knit: bookdown::preview_chapter
---

# Accessing Data

<!-- Topics to cover here 
lots of ways to read  in data: flat file, proprietary, data.table??, databases, scraping, json, shape files, netcdfs,  ...

missing values
-->

Data can be delivered in many ways, which makes it necessary to have a multitude of ways to harvest it. 

## Flat files

Flat files, like comma or tab separated values (`csv`, `tsv`), or values specified by fixed column widths, can be accessed simply, once the format is determined. This is also a very common format is used for very large data, for example, hadoop, where the data is partitioned into many small chunks overlaid with a system to access it. 

### Example: tuberculosis

The World Health Organisation (WHO) distributes data on tuberculosis case notifications through their web site at https://www.who.int/tb/country/data/download/en/. Download the latest case notifications data set, which is provided in `csv` format. A data dictionary is also provided explaining the format of the file, and information recorded. The data can be read into R using the code below:

```{r}
library(tidyverse)
library(DT)
tb <- read_csv(here::here("data", "TB_notifications_2020-01-04.csv"))
datatable(tb %>% top_n(10))
```

This data has 8286 rows and 164 columns. Its not in tidy form yet, so you will see this again in the tidying material to learn how to get a messy data set wrangled. The `read_csv` function provides a `tibble` data object in R. An alternative approach to reading is with the base function `read.csv` which will provide a `data.frame` object. 

### Your turn: atmospheric carbon dioxide 

Atmospheric carbon dioxide recordings are delivered by the Scripps CO$_2$ program, and available at https://scrippsco2.ucsd.edu/data/atmospheric_co2/sampling_stations.html.

Choose a station and download or directly read the csv file. You will need to skip over a number of lines at the top of the file in order to read only the data.

```{r eval=FALSE, echo=FALSE}
CO2.spo <- read_csv("https://scrippsco2.ucsd.edu/assets/data/atmospheric/stations/merged_in_situ_and_flask/daily/daily_merge_co2_spo.csv", col_names=c("date", "time", "day", "decdate", "n", "flg", "co2"), skip=69)
```


### Example: standardised test scores for reading, science and math

Every three years the OECD's Programme for International Student Assessment measures the ability of 15 year old students across the globe in reading, science and mathematics skills. This data is made available at https://www.oecd.org/pisa/. The format that the data is distributed in, is different from survey to survey, with the earliest years being text files, and later years in proprietary formats. The text files have fixed width format, where each variable occupies a fixed set of columns in the text. 

Let's take a look at the 2006 student data. Download the file from the OECD web site -- you should find that it is named `INT_Stu06_Dec07.txt`, or work with the subset of the first 2000 rows that is provided here. 

```{r}
# This is a previously generated data object of the coolumn widths of variables 
load(here::here("data", "PISA_student_2006_varwidths.rda"))
# To work with the full data set, use the downloaded file, INT_Sch06_Dec07.zip
# instead of INT_Stu06_Dec07_25k.txt
d <- read_fwf(file=here::here("data", "INT_Stu06_Dec07_2k.txt"), 
              col_positions=fwf_widths(var_widths$widths, 
                                       col_names=var_widths$names))
datatable(d %>% top_n(10))
```

The`learningtower` package available at https://github.com/ropenscilabs/learningtower contains the data for multiple years and code to process the source files.

### Your turn: land surface weather station data

The [Global Historical Climate Network](https://www.ncdc.noaa.gov/ghcn-daily-description) delivers data from land surface stations across the globe. Records for individual stations are provided using a fixed width format flat file. Find a station near you, and download the file. The list of [stations can be found here](https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/ghcnd-stations.txt). Your station file is identified by the station id. For example, the Melbourne airport station ID is ASN00086282, and thus the data file can be downloaded directly from ftp://ftp.ncdc.noaa.gov/pub/data/ghcn/daily/all/ASN00086282.dly.

Documentation on the file format and how to cite the archive is available at https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt. The column widths of the variables can be determined from this information. 

1. Work out the column widths for each variable
2. Write the code to read in this fixed width format

```{r eval=FALSE, echo=FALSE}
# Remote address for file
# fl <- "ftp://ftp.ncdc.noaa.gov/pub/data/ghcn/daily/all/ASN00086282.dly"
# Copy available with book
fl <- "data/ASN00086282.dly"
melb <- read_fwf(fl,    
                 col_positions=fwf_widths(c(11, 4, 2, 4, rep(c(5, 1, 1, 1), 31))))
glimpse(melb)
```

The data is far from tidy, and needs considerable work to get it into a suitable format for analysis. 

A more friendly and tider `csv` formatted data have been made available recently which can be acessed through the https server on the same location.

```{r eval=FALSE, echo=FALSE}
melb <- read_csv("https://www.ncei.noaa.gov/data/global-historical-climatology-network-daily/access/ASN00086282.csv")
```


## Proprietary formats

Data is often delivered in a specialist formats developed by a company, or individual, that has a  special encoding scheme. Examples include excel files, SAS or SPSS files. These require decoding in order to read. 

### Example: Australia air traffic data

The [Australian Department of Infrastructure, Transport, Cities and Regional Development](https://www.bitre.gov.au/publications/ongoing/airport_traffic_data) provides excel format files summarising air traffic at airports. Download the most recent data, and open the excel file. There are multiple sheets. The third sheet has passenger numbers. There are 6 rows of meta-information, which need to be ignored when reading the data. 

```{r}
library(readxl)
passengers <- read_xlsx(here::here("data", "WebAirport_FY_1986-2019.xlsx"), sheet=3, skip=6)
datatable(passengers)
```

### Your turn: Munging spreadsheets

The book [Spreaadsheet Munging Strategies](https://nacnudus.github.io/spreadsheet-munging-strategies/index.html) by Duncan Garmonsway is a really good source of dealing with complicated excel spreadsheets. We recommend working through examples in this book to familiarise ways to deal with messy spreadsheets, and incorporating information such as special formatting into the data. 

The [case study](https://nacnudus.github.io/spreadsheet-munging-strategies/vaccinations.html#vaccinations) developed from Bob Rudis's post on CDC vaccination data is especially recommended.

<!--
### Your turn: New Zealand Census data

StatsNZ makes [tables of data from the five year censuses](http://nzdotstat.stats.govt.nz/) publicly available. Take a look at the 2018 Census data, the population and migration data. You need to expand the cells, and select the levels to use, to have the numbers broken down by age group, sex and ethnicity. (A sample file `NZ_census.xlsx` is provided as an example.) In excel format, the variables and levels of the variables are in the header names, with a twist, a row for each variable, in a multicolumn format. (The R package `tidyxl` has the capacity to deal with multiple headers like this, but requires `xlsx` format. The sample file has been opened and saved in this format, and the first two blank lines in the origial file were also manually removed.)

Luckily, choosing the `csv` format will provide the data in tidy long form. 

GIVING UP ON THE XLS FORMAT - ITS JUST REALLY IRREGULAR - AND tidyxl even cannot handle it.
-->

```{r eval=FALSE, echo=FALSE}
library(tidyxl)
library(unpivotr)
NZ_all_cells <-
  xlsx_cells(here::here("data", "NZ_census.xlsx")) %>%
  dplyr::filter(!is_blank) %>%
  select(row, col, data_type, character, numeric) %>%
  dplyr::filter(row > 1)
year <-
  NZ_all_cells %>%
  dplyr::filter(col >= 2, row == 5) %>%
  select(row, col, year = character)
ethnic <-
  NZ_all_cells %>%
  dplyr::filter(col >= 2, row == 4) %>%
  select(row, col, ethnic = character)
sex <-
  NZ_all_cells %>%
  dplyr::filter(col >= 2, row == 3) %>%
  select(row, col, sex = character)
age <-
  NZ_all_cells %>%
  dplyr::filter(col >= 2, row == 2) %>%
  select(row, col, age = character)
NZ <- read_xlsx(here::here("data", "NZ_census.xlsx"), skip=5, n_max=1) %>%
  gather(v, count, -Area) %>%
  filter(!is.na(count)) %>%
  select(-v)
NZ <- NZ %>%
  mutate(year = year$year) %>%
  mutate(ethnic = rep(ethnic$ethnic, c(rep(3, length(ethnic$ethnic)-1), 1))) %>%
  mutate(sex = rep(sex$sex, 43))
# NZ <- read_xls(here::here("data", "NZ_census.xls"), skip=2)
# NZ <- read_csv("data/NZ_census.csv")
```


### Example: SPSS binary


PISA - sav

## JSON

cross-currency

## Reading multiple files from a website

sawfish

## Shapefiles

## Databases